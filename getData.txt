## let's start by trying to get some of Richard Cronn's needle
## data from NCBI/SRA

## following examples from:
https://github.com/ncbi/sra-tools/wiki/Download-On-Demand

## many but not all runs listed at:
https://www.ncbi.nlm.nih.gov/Traces/study/?acc=SRP018395

## just starting with one:

## SRA has its own set of command line tools. 

prefetch SRR669789

## while we're at it....
prefetch SRR669871  
prefetch SRR669834  

## where are these going? 

srapath SRR669834  
"/home/daniel/ncbi/public/sra/"

## these are not 

## how do we get all of the runs or samples associated
## with a project?

tar -xzf edirect.tar.gz

#################

## okay, but what if need genbank gene acessions, not the 
## read libraries?

esearch -db protein -query "lycopene cyclase" | efetch -format fasta

esearch -db nucleotide -query "lycopene cyclase [prot] fungi [ORGN]" | efetch -format full -mode json |& tee "lycopene.json"


esearch -db  -query "lignin peroxidase [nt] fungi [ORGN] NOT bacteria [ORGN] " | efetch -format full -mode json

esearch -db nucleotide -query "lignin peroxidase" -spell -field DEFINITION

## plan: 

## check size of Cronn project, see if we have room on this computer to download all. 
##  if not, just grab a couple more to train methods
## get mRNA sequences for them all:

cutinase[All Fields] AND (fungi[filter] AND biomol_mrna[PROP])


## how can we do this with entrez?

## figure out how to query keywords and limit to fungi.

## get list of terms of interest. 

## can we take top, best hits?


## ugh. Another night and nothing to show for it. 

## Okay, we need to show the case for two ideas:

## 1 - there are fungal reads in these studies. 

## 2 - there are correlated, potentially ecologically meaningful 
##     changes in the fungal-origin and host RNA. 

## so - for #1, get . Set up the runinfo, do the following:

## download a sample
## blast it for the set of fungal indicators
## collect counts and run metadata
## delete r

## let's tool around in talapas for a bit:

## get an interactive session in talapas

srun --pty bash

## our storage is at:

cd /projects/xylaria/dthomas

## modules
module load blast
module load bbmap

## we need to get a list of all the projects/samples
## of Dougfir from SRA:

## there are two projects I'm interested in:



## to get a list of this project

aa='PRJNA188506' 

wget 'http://trace.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?save=efetch&rettype=runinfo&db=sra&term=$aa' -O - 

wget 'http://trace.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?save=efetch&rettype=runinfo&db=sra&term='$aa -O SraRunInfo2.csv

wget 'http://trace.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?save=efetch&rettype=runinfo&db=sra&term=PRJNA188506' -O - 

wget 'http://trace.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?save=efetch&rettype=runinfo&db=sra&term=PRJNA188506' -O - | tee SraRunInfo.csv

## once entrez are place, can also do this:

esearch -db sra -query PRJNA40075  | efetch --format runinfo | cut -d ',' -f 1 


## okay, so once you have this, how do you get the files?

## I think we just want the first column:

bb=$(cut -d ',' -f 1  SraRunInfo.csv)

for i in ${bb}; do 
echo $i
done

## taking just the last one, can we download the sample using this value?

## can we get sra tools work locally on talapas?
wget https://ftp-trace.ncbi.nlm.nih.gov/sra/sdk/current/sratoolkit.current-centos_linux64.tar.gz
ln -s /projects/xylaria/dthomas/sratoolkit/bin/prefetch /projects/xylaria/dthomas/prefetch
ln -s /projects/xylaria/dthomas/sratoolkit/bin/fastq-dump /projects/xylaria/dthomas/fastq-dump

## anyway, can get the raw reads from one SRA run ID?

./fastq-dump -Z $i > $i.fastq

## seems to be working...

## got to convert to fasta - best utility for this?
## I remember bbmap was good...

reformat.sh in=$i.fastq out=$i.fasta

## now to blast it for sequences of interest?

makeblastdb -in $i.fasta -parse_seqids -dbtype nucl &

blastn –db $i.fastq –query nt.fsa –out $i.out


## after getting the results, cleanup:
## rm $i.fastq 

## accidentally put the fastq at:
ls -l /projects/xylaria/dthomas/sratoolkit/bin/SRR669871.fastq

## we need some genes:

## how to build a fasta with what we need?


## ergosterol:

erg6p
erg2p
erg5p
erg4p


## fungal chitan synthase

## this is my search:
## https://www.ncbi.nlm.nih.gov/nuccore?term=CHS%5BAll%20Fields%5D%20OR%20chitin%20synthase%5BAll%20Fields%5D%20AND%20%28fungi%5Bfilter%5D%20AND%20biomol_mrna%5BPROP%5D%29&cmd=DetailsSearch

## 


## anthocyanins



